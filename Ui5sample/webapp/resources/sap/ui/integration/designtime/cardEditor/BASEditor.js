/*!
 * OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/util/restricted/_CancelablePromise","sap/base/util/restricted/_isEqual","sap/base/util/restricted/_omit","sap/base/util/merge","sap/base/util/deepClone","sap/base/util/ObjectPath","./CardEditor","sap/ui/integration/designtime/baseEditor/BaseEditor","sap/ui/integration/Designtime","sap/ui/integration/util/CardMerger","sap/base/util/LoaderExtensions","sap/base/Log"],function(C,_,a,m,d,O,b,B,D,c,L,e){"use strict";var f="";f=L.loadResource("sap/ui/integration/designtime/cardEditor/ConfigurationTemplate.js",{dataType:"text",failOnError:false,async:false});var g=b.extend("sap.ui.integration.designtime.cardEditor.BASEditor",{metadata:{library:"sap.ui.integration",events:{configurationChange:{},createConfiguration:{},error:{}}},renderer:b.getMetadata().getRenderer()});g.prototype.getManifest=function(){return this._oCurrent.manifest;};g.prototype.getConfigurationClass=function(){return this._oCurrent.configurationclass;};g.prototype.getConfiguration=function(){return this._oCurrent.configuration;};g.prototype.getConfigurationString=function(){return this._oCurrent.configurationstring;};g.prototype._generateDesigntimeJSConfig=function(){var M=this._formatExportedDesigntimeMetadata(this.getDesigntimeMetadata());var J=this.getJson();if(this._eventTimeout){clearTimeout(this._eventTimeout);this._eventTimeout=null;}var k=m({},this._oDesigntimeJSConfig);this._eventTimeout=setTimeout(function(){var N={};var I=[];var l;if(J){var p=O.get(["sap.card","configuration","parameters"],J);if(!p){this._oCurrent={configuration:this._cleanConfig(this._oDesigntimeJSConfig),manifest:this._cleanJson(),configurationclass:this._fnDesigntime};this.fireConfigurationChange(this._oCurrent);return;}var q=Object.keys(p);for(var n in k.form.items){l=m({},k.form.items[n]);if(!p[n]){delete k.form.items[n];continue;}var r=q.indexOf(n);if(r>-1){q.splice(r,1);}var v;if(k.form.items[n].visualization){v=k.form.items[n].visualization;}k.form.items[n]=m(l,p[n]);if(v){k.form.items[n].visualization=v;v=null;}}if(q.length>0){for(var i=0;i<q.length;i++){var s=q[i];var u=p[s];k.form.items[s]={manifestpath:"/sap.card/configuration/parameters/"+s+"/value",type:u.type,label:u.label,translatable:false,editable:u.editable,visible:u.visible};}p[s]=m(k.form.items[s],p[s]);}}if(M){var p=O.get(["sap.card","configuration","parameters"],J);if(k){for(var n in M){var w=M[n];var K=n.substring(n.lastIndexOf("/")+1);if(!n.startsWith("sap.card/configuration/parameters")){continue;}var x=k.form.items[K];var v;if(x.visualization){v=x.visualization;}l=m(x||{},p[K]);l.label=w.hasOwnProperty("label")&&w.label;l.position=w.hasOwnProperty("position")&&w.position;if(l.editable==="false"){l.editable=false;}else if(l.editable==="true"){l.editable=false;}if(l.visible==="false"){l.visible=false;}else if(l.visible==="true"){l.visible=false;}if(v){l.visualization=v;v=null;}l.__key=K;I[l.position]=l;}for(var i=0;i<I.length;i++){l=I[i];if(!l){continue;}N[l.__key]=l;delete l.__key;delete l.position;}k.form.items=N;}}this._oDesigntimeJSConfig=k;this._fnDesigntime=function(o){return new D(o);}.bind(this,this._oDesigntimeJSConfig);this._oCurrent={configuration:this._cleanConfig(this._oDesigntimeJSConfig),manifest:this._cleanJson(),configurationclass:this._fnDesigntime,configurationstring:this._cleanConfig(this._oDesigntimeJSConfig,true)};this.fireConfigurationChange(this._oCurrent);}.bind(this),500);};g.prototype.init=function(){b.prototype.init.apply(this,arguments);this._oCurrent={configuration:null,manifest:null,configurationclass:null};};g.prototype._applyDefaultValue=function(i){if(i.value===undefined||i.value===null){switch(i.type){case"boolean":i.value=i.defaultValue||false;break;case"integer":case"number":i.value=i.defaultValue||0;break;case"string[]":i.value=i.defaultValue||[];break;default:i.value=i.defaultValue||"";}}};g.prototype._cleanJson=function(J){J=J||this.getJson();var s=j(O.get(["sap.card","designtime"],J)||"");if(!s){O.set(["sap.card","designtime"],"dt/configuration",J);}J=d(J);var p=O.get(["sap.card","configuration","parameters"],J);for(var n in p){var P=p[n];if(P&&P.manifestpath&&!P.manifestpath.startsWith("/sap.card/configuration/parameters")){delete p[n];continue;}p[n]={value:p[n].value};}if(this._i18n){O.set(["sap.app","i18n"],this._i18n,J);}return J;};g.prototype._cleanConfig=function(o,S){var o=m({},o);for(var n in o.form.items){var i=o.form.items[n];delete i.value;if(i.visualization&&i.visualization.type&&typeof i.visualization.type==="function"){if(i.visualization.type.getMetadata&&i.visualization.type.getMetadata()){var k=i.visualization.type.getMetadata().getName().replace(/\./g,"/");if(S){var I=k.lastIndexOf("/");k=I>0?k.substring(I+1):k;i.visualization.type="$$"+k+"$$";}else{i.visualization.type=i.visualization.type.getMetadata().getName().replace(/\./g,"/");}}}}if(S){var l=JSON.stringify(o,null,"\t");l=l.replace(/\"\$\$([a-zA-Z]*)\$\$\"/g,function(s){return s.substring(3,s.length-3);});return l;}return o;};g.prototype._generateMetadataFromJSConfig=function(){var M={};if(this._oDesigntimeJSConfig){var I=this._oDesigntimeJSConfig.form.items;var i=0;for(var n in I){var p="sap.card/configuration/parameters/"+n,P=p.split("/"),o;M[p]=m({},I[n]);o=M[p];o.position=i++;if(o.visualization){o.visualization=1;}if(!o.manifestpath.startsWith("/sap.card/configuration/parameters/")||!O.get(P,this._oInitialJson)){O.set(P,o,this._oInitialJson);}O.set(P,o,this._oInitialJson);if(!o.hasOwnProperty("type")){this.fireError({"name":"Designtime Error","detail":{"message":"Type of parameter "+n+" not exist"}});}else if(o.type===""){this.fireError({"name":"Designtime Error","detail":{"message":"Type of parameter "+n+" is Invalid"}});}if(!o.hasOwnProperty("value")){var k=o.manifestpath.substring(1).split("/"),v=O.get(k,this._oInitialJson);if(v!==undefined){o.value=v;}else{this._applyDefaultValue(o);}}else{this._applyDefaultValue(o);}if(O.get(P,this._oInitialJson)){if(O.get(P,this._oInitialJson).value===undefined){O.get(P,this._oInitialJson).value=o.value;}}}}return M;};g.prototype.setJson=function(J){if(!this._i18n){this._i18n=O.get(["sap.app","i18n"],J);}B.prototype.setJson.apply(this,arguments);if(!this.__generateDesigntimeJSConfigAttached){this.attachDesigntimeMetadataChange(this._generateDesigntimeJSConfig.bind(this));this.attachJsonChange(this._generateDesigntimeJSConfig.bind(this));this.__generateDesigntimeJSConfigAttached=true;}var J=this.getJson();var s=O.get(["sap.app","id"],J);if(this._bDesigntimeInit&&this._bCardId!==s){if(this._oDesigntimePromise){this._oDesigntimePromise.cancel();}delete this._bCardId;delete this._bDesigntimeInit;}if(!this._bDesigntimeInit){this.setPreventInitialization(true);this._bCardId=s;var T;var i=j(O.get(["sap.card","designtime"],J)||"");if(!i){var k=f;O.set(["sap.card","designtime"],"dt/configuration",J);T="sap/ui/integration/designtime/cardEditor/ConfigurationTemplate";this.fireCreateConfiguration({file:"dt/configuration.js",content:k,manifest:this._cleanJson(J)});return;}var l=j(this.getBaseUrl()||"");if(l&&i){var p={};var S=j(l);var n=t(i);var q=S+"/"+n;var N=s.replace(/\./g,"/")+"/"+n;p[N]=q;p[N+"js"]=q.substring(0,q.lastIndexOf("/"));var F=q.replace(p[N+"js"]+"/","");sap.ui.loader.config({paths:p});var r=this;this._oDesigntimePromise=new C(function(R){var u=N+"js"+"/"+F+".js";if(T){u=T+".js";}sap.ui.loader._.loadJSResourceAsync(u).then(function(o){if(!o){}else if(o){var v=new o();r._oDesigntimeJSConfig=v.getSettings();r._fnDesigntime=o;var M=r._generateMetadataFromJSConfig(r._oDesigntimeJSConfig);o=v.getMetadata().getClass();R(M);}}).catch(function(o){e.error(o);r.fireError({"name":"Designtime Error","detail":o});});});this._oDesigntimePromise.then(function(M){this.setPreventInitialization(false);var o=M;o=c.mergeCardDesigntimeMetadata(o,this.getDesigntimeChanges());this._oInitialDesigntimeMetadata=o;this.setDesigntimeMetadata(h(o),true);this._bDesigntimeInit=true;}.bind(this));}else{this.setPreventInitialization(false);}}};g.prototype.getConfigurationTemplate=function(){return f;};function h(F){var o={};Object.keys(F).forEach(function(p){O.set(p.split("/"),{__value:d(F[p])},o);});return o;}function j(p){return p.trim().replace(/\/*$/,"");}function t(p){return p.replace(/^\.\//,"");}return g;});
