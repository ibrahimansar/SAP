/*!
 * OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/dt/OverlayRegistry","sap/ui/dt/ElementOverlay","sap/ui/dt/AggregationOverlay","sap/ui/dt/Util","sap/ui/fl/write/api/ExtensionPointRegistryAPI","sap/base/util/deepEqual","sap/base/util/isEmptyObject","sap/base/util/merge","sap/base/util/restricted/_omit"],function(O,E,A,D,a,d,i,m,_){"use strict";return function(r,p){var o={};o.mExtensionPointMetadata={palette:{icons:{svg:"sap/ui/core/designtime/Icon.icon.svg"}}};o._getOutline=function(I,b){var R;if(!b&&D.isInteger(I)){b=I;I=undefined;}var c=[];if(!I){c=r._oDesignTime.getRootElements().map(function(s){return O.getOverlay(s);});}else{var P=O.getOverlay(I);if(!P){throw D.createError("services.Outline#get","Cannot find element with id= "+I+". A valid or empty value for the initial element id should be provided.","sap.ui.rta");}c.push(P);}R=c.map(function(e){return this._getChildrenNodes(e,b);},this);return R;};o._getExtensionPoints=function(b){var P=b.id;var s=b.technicalName;return a.getExtensionPointInfoByParentId({parentId:P}).filter(function(e){return e.aggregationName===s;});};o._getExtensionPointData=function(e){return{id:e.targetControl.getId(),name:e.name,technicalName:"sap.ui.extensionpoint",type:"extensionPoint",icon:this.mExtensionPointMetadata.palette.icons.svg,extensionPointInfo:{defaultContent:e.defaultContent.map(function(c){return c.getId();})}};};o._enrichExtensionPointData=function(b){var I=sap.ui.getCore().getConfiguration().getDesignMode();if(b.type==="aggregation"&&I){var e=this._getExtensionPoints(b).sort(function(c,f){return f.index-c.index;});e.forEach(function(c){var f=this._getExtensionPointData(c);b.elements.splice(c.index,0,f);}.bind(this));}};o._getChildrenNodes=function(b,c,P){var v=D.isInteger(c);if(b.getShouldBeDestroyed()){return{};}var e=this._getNodeProperties(b,P)||{};var C=b.getChildren();if((!v||(v&&c>0))&&C.length>0&&!i(e)){c=v?c-1:c;e.elements=C.map(function(f){return this._getChildrenNodes(f,c,f.getParent());},this).filter(function(f){return!i(f);});this._enrichExtensionPointData(e);}return e;};o._getNodeProperties=function(b,P){var c;var s;var t;var v;var I=false;var e=b.getElement();var f=e.getId();var g=e.getMetadata().getName();var h=b.getDesignTimeMetadata();var j=h.getData();var k=h.getLabel(e);var l=(j.palette&&j.palette.icons&&j.palette.icons.svg||undefined);if(b instanceof E){t="element";I=b.getEditable();c=h.getName(e);v=b.isVisible();}else{t="aggregation";s=b.getAggregationName();c=P.getAggregation(s)?P.getDesignTimeMetadata().getAggregationDescription(s,e):undefined;}var n=Object.assign({id:f,technicalName:s||g,editable:I,type:t},k!==f&&k!==undefined&&{instanceName:k},c&&c.singular&&{name:c.singular},l!==undefined&&{icon:l},typeof v==="boolean"&&{visible:v});return n;};o._removeDuplicate=function(R,b){return R.filter(function(u){return!d(b,u,Infinity);});};o._updatesHandler=function(e){var P=e.getParameters();if(this.sStatus==="initial"){this.aUpdates=[];}var R=m({},P);var s=R.id?O.getOverlay(R.id).getElement().getId():undefined;var t=R.targetId?O.getOverlay(R.targetId).getElement().getId():undefined;switch(e.getId()){case"elementOverlayCreated":if(P.elementOverlay.isRoot()){var b=P.elementOverlay.getElement().getId();R.element=o._getOutline(b)[0];R.type="new";break;}return;case"elementOverlayAdded":R.element=o._getOutline(s)[0];R.targetId=t;R.type="new";break;case"elementOverlayMoved":R.element=o._getOutline(s,0)[0];R.targetId=t;R.type="move";break;case"elementOverlayDestroyed":var c=R.elementOverlay.getParentAggregationOverlay();if((c instanceof A&&!c._bIsBeingDestroyed)||R.elementOverlay.isRoot()){R.element={};R.element.id=R.elementOverlay.getElement()?R.elementOverlay.getElement().getId():R.elementOverlay.getAssociation("element");R.type="destroy";break;}return;case"elementOverlayEditableChanged":R.element={id:s,editable:R.editable};R.type="editableChange";break;case"elementPropertyChanged":R.element=o._getOutline(s,0)[0];R.type="elementPropertyChange";break;}R=_(R,["elementOverlay","editable","target","id","elementId"]);this.aUpdates=o._removeDuplicate(this.aUpdates,R);this.aUpdates.push(R);if(this.sStatus==="initial"){setTimeout(function(){if(Array.isArray(this.aUpdates)&&this.aUpdates.length>0){this.sStatus="initial";p("update",this.aUpdates);}}.bind(o),200);}this.sStatus="processing";};o.destroy=function(){r._oDesignTime.detachEvent("elementOverlayCreated",this._updatesHandler,this);r._oDesignTime.detachEvent("elementOverlayAdded",this._updatesHandler,this);r._oDesignTime.detachEvent("elementOverlayMoved",this._updatesHandler,this);r._oDesignTime.detachEvent("elementOverlayDestroyed",this._updatesHandler,this);r._oDesignTime.detachEvent("elementPropertyChanged",this._updatesHandler,this);r._oDesignTime.detachEvent("elementOverlayEditableChanged",this._updatesHandler,this);delete this.aUpdates;delete this.sStatus;};o.aUpdates=[];o.sStatus="initial";r._oDesignTime.attachEvent("elementOverlayCreated",o._updatesHandler,o);r._oDesignTime.attachEvent("elementOverlayAdded",o._updatesHandler,o);r._oDesignTime.attachEvent("elementOverlayMoved",o._updatesHandler,o);r._oDesignTime.attachEvent("elementOverlayDestroyed",o._updatesHandler,o);r._oDesignTime.attachEvent("elementPropertyChanged",o._updatesHandler,o);r._oDesignTime.attachEvent("elementOverlayEditableChanged",o._updatesHandler,o);return{events:["update"],exports:{get:o._getOutline.bind(o)},destroy:o.destroy.bind(o)};};});
